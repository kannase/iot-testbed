name: IoT Test Automation Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install robotframework robotframework-mqttlibrary paho-mqtt==1.6.1

      - name: Start Mosquitto Broker
        run: |
          sudo apt-get update
          sudo apt-get install -y mosquitto mosquitto-clients
          sudo service mosquitto start

      - name: Start IoT Simulator & Wait for Port
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          # Start simulator in background and log output
          python simulator/iot_device_simulator.py > simulator_log.txt 2>&1 &
          
          echo "Waiting for MQTT broker on port 1883..."
          # This is the "smart" wait - it checks the port directly
          timeout 15s bash -c 'until printf "" 2>>/dev/null >/dev/tcp/127.0.0.1/1883; do sleep 1; done'
          echo "Broker is confirmed UP!"

      - name: Run Robot Framework Tests
        run: |
          mkdir -p results
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          robot --outputdir results tests/robot/

      - name: Upload Test Results and Debug Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-artifacts
          path: |
            results/
            simulator_log.txt